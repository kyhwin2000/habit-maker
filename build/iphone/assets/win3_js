var osname=Ti.Platform.osname,version=Ti.Platform.version,scrHeight=Ti.Platform.displayCaps.platformHeight,scrWidth=Ti.Platform.displayCaps.platformWidth,defaultFontSize="android"===Ti.Platform.name?16:14,curWin=Ti.UI.currentWindow,tileWidth=scrWidth/7,date=new Date,datesOnMonth=[31,31,28,31,30,31,30,31,31,30,31,30,31],days=["일","월","화","수","목","금","토"],selectedRow=Ti.App.Properties.getInt("selectedRow"),db=Ti.Database.open("habitDB"),checkDB=function(){var e=db.execute("SELECT * FROM habit");Ti.API.info("Row count: "+e.rowCount);var t;for(t="android"===Ti.Platform.name?e.fieldCount:e.fieldCount(),Ti.API.info("Field count: "+t);e.isValidRow();)Ti.API.info("habit ---> name: "+e.fieldByName("name")+", days: "+e.fieldByName("days")+", status: "+e.fieldByName("status")),e.next()},parseDB=function(){for(var e=db.execute("SELECT * FROM habit"),t=0;t!=selectedRow;)e.next(),t++;var i=JSON.parse(e.fieldByName("days"));return i},currentYear=date.getFullYear(),currentMonth=date.getMonth()+1,currentDate=date.getDate(),calculateDate=function(e,t,i){var r,a,n,o;for(r=365*(e-1)+parseInt((e-1)/4)-parseInt((e-1)/100)+parseInt((e-1)/400),(0==e%4&&0!=e%100||0==e%400)&&(datesOnMonth[2]=29),a=0,o=1;t>o;o++)a+=datesOnMonth[o];return n=parseInt(r+a+i)},monthName=Ti.UI.createLabel({text:currentYear+"년 "+currentMonth+"월",top:50,left:scrWidth/2-60,textAlign:"center",font:{fontSize:24}});curWin.add(monthName);var previousMonth=Ti.UI.createImageView({image:"left-arrow.png",top:50,left:0});curWin.add(previousMonth);var nextMonth=Ti.UI.createImageView({image:"right-arrow.png",top:50,left:scrWidth-60});curWin.add(nextMonth),previousMonth.addEventListener("click",function(){currentMonth>1&&12>=currentMonth?currentMonth--:1>=currentMonth&&(currentYear--,currentMonth+=11),drawCalendar(currentYear,currentMonth)}),nextMonth.addEventListener("click",function(){currentMonth>=1&&12>currentMonth?currentMonth++:currentMonth>=12&&(currentYear++,currentMonth-=11),drawCalendar(currentYear,currentMonth)});for(var dayName=Array(7),d=0;7>d;d++)dayName[d]=Ti.UI.createLabel({backgroundColor:"gray",color:"white",text:days[d],textAlign:"center",top:100,left:0+d*tileWidth,width:tileWidth,height:30}),curWin.add(dayName[d]);var drawCalendar=function(e,t){var i=Array(42),r=Array(42),a=calculateDate(e,t,1)%7;monthName.setText(e+"년 "+t+"월");for(var n=0;i.length>n;n++){if(n>=a&&datesOnMonth[t]+(a-1)>=n)if(n==currentDate-a+3)i[n]=Ti.UI.createView({borderRaduis:3,borderColor:"gray",top:130,left:0+n*tileWidth,width:tileWidth,height:30,backgroundColor:"white"}),curWin.add(i[n]),r[n]=Ti.UI.createLabel({top:130,left:0+n*tileWidth,textAlign:"center",width:tileWidth,height:30,text:n-a+1,color:"blue"}),curWin.add(r[n]);else{i[n]=Ti.UI.createView({borderRaduis:3,borderColor:"gray",top:130,left:0+n*tileWidth,width:tileWidth,height:30,backgroundColor:"white"}),curWin.add(i[n]),r[n]=Ti.UI.createLabel({top:130,left:0+n*tileWidth,textAlign:"center",width:tileWidth,height:30,text:n-a+1,color:"black"}),curWin.add(r[n]);for(var o in parseDB()){var d=currentYear+"-"+currentMonth+"-"+r[n].getText(),l=parseDB()[o];if(d==l){var h=Ti.UI.createImageView({image:"/checkmark.png"});r[n].add(h)}}}else a>n?(i[n]=Ti.UI.createView({borderRaduis:3,borderColor:"gray",top:130,left:0+n*tileWidth,width:tileWidth,height:30,backgroundColor:"white"}),curWin.add(i[n]),r[n]=Ti.UI.createLabel({top:130,left:0+n*tileWidth,text:datesOnMonth[t-1]-(a-n)+1,textAlign:"center",width:tileWidth,height:30,color:"gray"}),curWin.add(r[n])):(i[n]=Ti.UI.createView({borderRaduis:3,borderColor:"gray",top:130,left:0+n*tileWidth,width:tileWidth,height:30,backgroundColor:"white"}),curWin.add(i[n]),r[n]=Ti.UI.createLabel({top:130,left:0+n*tileWidth,text:n-(datesOnMonth[t]+(a-1)),textAlign:"center",width:tileWidth,height:30,color:"gray"}),curWin.add(r[n]));n>=7&&14>n?(i[n].setTop(i[n].getTop()+30),i[n].setLeft(i[n].getLeft()-7*tileWidth),r[n].setTop(r[n].getTop()+30),r[n].setLeft(r[n].getLeft()-7*tileWidth)):n>=14&&21>n?(i[n].setTop(i[n].getTop()+60),i[n].setLeft(i[n].getLeft()-14*tileWidth),r[n].setTop(r[n].getTop()+60),r[n].setLeft(r[n].getLeft()-14*tileWidth)):n>=21&&28>n?(i[n].setTop(i[n].getTop()+90),i[n].setLeft(i[n].getLeft()-21*tileWidth),r[n].setTop(r[n].getTop()+90),r[n].setLeft(r[n].getLeft()-21*tileWidth)):n>=28&&35>n?(i[n].setTop(i[n].getTop()+120),i[n].setLeft(i[n].getLeft()-28*tileWidth),r[n].setTop(r[n].getTop()+120),r[n].setLeft(r[n].getLeft()-28*tileWidth)):n>=35&&(i[n].setTop(i[n].getTop()+150),i[n].setLeft(i[n].getLeft()-35*tileWidth),r[n].setTop(r[n].getTop()+150),r[n].setLeft(r[n].getLeft()-35*tileWidth)),r[n].addEventListener("click",function(){var e=Ti.UI.createImageView({image:"/checkmark.png"});if(""!=this.getChildren()){for(var t in this.children)this.remove(this.children[t]);var i=currentYear+"-"+currentMonth+"-"+this.getText(),r=parseDB();r.splice(r.indexOf(i),1);var a=JSON.stringify(r);db.execute("UPDATE habit SET days=? WHERE id=?",a,selectedRow+1),db.execute("UPDATE habit SET status=? WHERE id=?",parseDB().length+"%",selectedRow+1),checkDB()}else{this.add(e);var n=currentYear+"-"+currentMonth+"-"+this.getText(),r=parseDB();r.push(n);var a=JSON.stringify(r);db.execute("UPDATE habit SET days=? WHERE id=?",a,selectedRow+1),db.execute("UPDATE habit SET status=? WHERE id=?",parseDB().length+"%",selectedRow+1),checkDB()}})}};drawCalendar(currentYear,currentMonth);