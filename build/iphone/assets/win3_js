var osname=Ti.Platform.osname,version=Ti.Platform.version,scrHeight=Ti.Platform.displayCaps.platformHeight,scrWidth=Ti.Platform.displayCaps.platformWidth,defaultFontSize="android"===Ti.Platform.name?16:14,curWin=Ti.UI.currentWindow,tileWidth=scrWidth/7,date=new Date,datesOnMonth=[31,31,28,31,30,31,30,31,31,30,31,30,31],days=["일","월","화","수","목","금","토"],selectedRow=Ti.App.Properties.getInt("selectedRow"),checkDB=function(){var e=Ti.Database.open("habitDB"),t=e.execute("SELECT * FROM habit");Ti.API.info("Row count: "+t.rowCount);var i;for(i="android"===Ti.Platform.name?t.fieldCount:t.fieldCount(),Ti.API.info("Field count: "+i);t.isValidRow();)Ti.API.info("habit ---> name: "+t.fieldByName("name")+", days: "+t.fieldByName("days")+", status: "+t.fieldByName("status")),t.next();e.close()},parseDB=function(){for(var e=Ti.Database.open("habitDB"),t=e.execute("SELECT * FROM habit"),i=0;i!=selectedRow;)t.next(),i++;var a=JSON.parse(t.fieldByName("days"));return a},currentYear=date.getFullYear(),currentMonth=date.getMonth()+1,currentDate=date.getDate(),calculateDate=function(e,t,i){var a,r,n,o;for(a=365*(e-1)+parseInt((e-1)/4)-parseInt((e-1)/100)+parseInt((e-1)/400),(0==e%4&&0!=e%100||0==e%400)&&(datesOnMonth[2]=29),r=0,o=1;t>o;o++)r+=datesOnMonth[o];return n=parseInt(a+r+i)},monthName=Ti.UI.createLabel({text:currentYear+"년 "+currentMonth+"월",top:50,left:scrWidth/2-60,textAlign:"center",font:{fontSize:24}});curWin.add(monthName);var previousMonth=Ti.UI.createImageView({image:"left-arrow.png",top:50,left:0});curWin.add(previousMonth);var nextMonth=Ti.UI.createImageView({image:"right-arrow.png",top:50,left:scrWidth-60});curWin.add(nextMonth),previousMonth.addEventListener("click",function(){currentMonth>1&&12>=currentMonth?currentMonth--:1>=currentMonth&&(currentYear--,currentMonth+=11),drawCalendar(currentYear,currentMonth)}),nextMonth.addEventListener("click",function(){currentMonth>=1&&12>currentMonth?currentMonth++:currentMonth>=12&&(currentYear++,currentMonth-=11),drawCalendar(currentYear,currentMonth)});for(var dayName=Array(7),d=0;7>d;d++)dayName[d]=Ti.UI.createLabel({backgroundColor:"gray",color:"white",text:days[d],textAlign:"center",top:100,left:0+d*tileWidth,width:tileWidth,height:30}),curWin.add(dayName[d]);var drawCalendar=function(e,t){var i=Array(42),a=Array(42),r=calculateDate(e,t,1)%7;monthName.setText(e+"년 "+t+"월");for(var n=0;i.length>n;n++){if(n>=r&&datesOnMonth[t]+(r-1)>=n)if(n==currentDate-r+3)i[n]=Ti.UI.createView({borderRaduis:3,borderColor:"gray",top:130,left:0+n*tileWidth,width:tileWidth,height:30,backgroundColor:"white"}),curWin.add(i[n]),a[n]=Ti.UI.createLabel({top:130,left:0+n*tileWidth,textAlign:"center",width:tileWidth,height:30,text:n-r+1,color:"blue"}),curWin.add(a[n]);else{i[n]=Ti.UI.createView({borderRaduis:3,borderColor:"gray",top:130,left:0+n*tileWidth,width:tileWidth,height:30,backgroundColor:"white"}),curWin.add(i[n]),a[n]=Ti.UI.createLabel({top:130,left:0+n*tileWidth,textAlign:"center",width:tileWidth,height:30,text:n-r+1,color:"black"}),curWin.add(a[n]);for(var o in parseDB()){var d=currentYear+"-"+currentMonth+"-"+a[n].getText(),c=parseDB()[o];if(d==c){var l=Ti.UI.createImageView({image:"/checkmark.png"});a[n].add(l)}}}else r>n?(i[n]=Ti.UI.createView({borderRaduis:3,borderColor:"gray",top:130,left:0+n*tileWidth,width:tileWidth,height:30,backgroundColor:"white"}),curWin.add(i[n]),a[n]=Ti.UI.createLabel({top:130,left:0+n*tileWidth,text:datesOnMonth[t-1]-(r-n)+1,textAlign:"center",width:tileWidth,height:30,color:"gray"}),curWin.add(a[n])):(i[n]=Ti.UI.createView({borderRaduis:3,borderColor:"gray",top:130,left:0+n*tileWidth,width:tileWidth,height:30,backgroundColor:"white"}),curWin.add(i[n]),a[n]=Ti.UI.createLabel({top:130,left:0+n*tileWidth,text:n-(datesOnMonth[t]+(r-1)),textAlign:"center",width:tileWidth,height:30,color:"gray"}),curWin.add(a[n]));n>=7&&14>n?(i[n].setTop(i[n].getTop()+30),i[n].setLeft(i[n].getLeft()-7*tileWidth),a[n].setTop(a[n].getTop()+30),a[n].setLeft(a[n].getLeft()-7*tileWidth)):n>=14&&21>n?(i[n].setTop(i[n].getTop()+60),i[n].setLeft(i[n].getLeft()-14*tileWidth),a[n].setTop(a[n].getTop()+60),a[n].setLeft(a[n].getLeft()-14*tileWidth)):n>=21&&28>n?(i[n].setTop(i[n].getTop()+90),i[n].setLeft(i[n].getLeft()-21*tileWidth),a[n].setTop(a[n].getTop()+90),a[n].setLeft(a[n].getLeft()-21*tileWidth)):n>=28&&35>n?(i[n].setTop(i[n].getTop()+120),i[n].setLeft(i[n].getLeft()-28*tileWidth),a[n].setTop(a[n].getTop()+120),a[n].setLeft(a[n].getLeft()-28*tileWidth)):n>=35&&(i[n].setTop(i[n].getTop()+150),i[n].setLeft(i[n].getLeft()-35*tileWidth),a[n].setTop(a[n].getTop()+150),a[n].setLeft(a[n].getLeft()-35*tileWidth)),a[n].addEventListener("click",function(){var e=Ti.UI.createImageView({image:"/checkmark.png"});if(""!=this.getChildren()){for(var t in this.children)this.remove(this.children[t]);var i=currentYear+"-"+currentMonth+"-"+this.getText(),a=parseDB();a.splice(a.indexOf(i),1);var r=JSON.stringify(a),n=Ti.Database.open("habitDB");n.execute("UPDATE habit SET days=? WHERE id=?",r,selectedRow+1),n.execute("UPDATE habit SET status=? WHERE id=?",parseDB().length+"%",selectedRow+1),checkDB(),n.close()}else{this.add(e);var o=currentYear+"-"+currentMonth+"-"+this.getText(),a=parseDB();a.push(o);var r=JSON.stringify(a),n=Ti.Database.open("habitDB");n.execute("UPDATE habit SET days=? WHERE id=?",r,selectedRow+1),n.execute("UPDATE habit SET status=? WHERE id=?",parseDB().length+"%",selectedRow+1),checkDB(),n.close()}})}};drawCalendar(currentYear,currentMonth);